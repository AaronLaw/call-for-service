---
- name: Add Postgres apt key
  apt_key: url=https://www.postgresql.org/media/keys/ACCC4CF8.asc
- name: Add Postgres PPA
  apt_repository: repo="deb http://apt.postgresql.org/pub/repos/apt/ trusty-pgdg main"
  notify: Update apt cache
- name: Install Postgres
  apt: name={{item}} state=present
  with_items:
    - postgresql-9.4
    - postgresql-client-9.4
    - postgresql-contrib-9.4
    - postgresql-server-dev-9.4
    - libpq-dev
    - postgresql-9.4-postgis-2.1
    - postgresql-9.4-postgis-scripts
    - python-psycopg2
- become_user: postgres
  block:
  - name: Configure Postgres
    copy: src=postgresql.conf dest=/etc/postgresql/9.4/main/postgresql.conf owner=postgres group=postgres force=yes
    notify:
      - Restart Postgres
  - name: Configure Postgres Auth
    copy: src=pg_hba.conf dest=/etc/postgresql/9.4/main/pg_hba.conf owner=postgres group=postgres force=yes
    notify:
      - Restart Postgres
  - name: "Create datascientist user for Postgres"
    postgresql_user: name={{ database.user }} password={{ secret.db_password }} role_attr_flags=CREATEDB
  - name: "Create PostgreSQL databases"
    postgresql_db: name={{ database.name }} owner={{ database.user }} state=present